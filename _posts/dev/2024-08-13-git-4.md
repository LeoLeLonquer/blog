---
layout: article
category: dev
tags:
  - full_post
title: Git - 4 - Bons √† savoir
---
Dernier √©pisode de la s√©rie git, c'est un peu foutrac, parcourez l'article en fonction de ce que qui vous int√©resse !

<!--more-->

# Fichiers sp√©ciaux
## Le fichier `.gitignore`

Le fichier `.gitignore` permet d'√©viter l'indexation de certains documents sur le crit√®re de patterns. Il se trouve √† la racine de l'arbre de travail. On peut ignorer :

- des fichiers sp√©cifiques
- des patterns de fichiers
- des dossiers

Exemple de fichier `.gitignore` :

```python
# Ignorer les fichiers de configuration de l'environnement de d√©veloppement
.idea/
.vscode/
.classpath
.project

# Ignorer les fichiers de sauvegarde temporaires vim
*~
*.swp

# Ignorer les fichiers de logs
*.log

# Ignorer certains dossiers
lib/
var/
tmp/
tdsConfigGen/
```

Une fois que notre fichier est bien configur√©, on peut indexer et commiter plus rapidement sans se soucier de l'indexation de fichiers inutiles :

```bash
git add . && git commit -m "Mon message"
```

Vous pouvez demander √† ChatGPT ou [MistralAI](https://chat.mistral.ai/chat) (pour d√©fendre une solution fran√ßaise et open-source) de vous fournir un fichier `.gitignore` en pr√©cisant le langage, les librairies, les modules, le IDE utilis√©es. 

## Le fichier `.gitattributes`

Si vous avez des probl√®me de fin de lignes, car un des contributeurs.rices du projet est sur Linux quand l'autre est sur Windows, alors ajouter le fichier `.gitattributes` √† votre projet avec le contenu suivant :

```bash
# Adaptation automatique aux fins de ligne Windows ou Linux
* text=auto
```

Voir √©galement cet [exemple de fichier `.gitattributes` g√©n√©r√© par Codestral](https://gist.github.com/LeoLeLonquer/4117bf7b413789eb62be8dc69b5c9526). 

# Commandes en plus
## Cr√©er des alias
_git alias, alias_

Certaines commandes git sont trop longues pour vous ? Utiliser les alias ! Il y a en deux types : les alias git, les alias bash.

#### Les alias git

Les alias git sont des commandes de type `git <alias>`  et qui sont associ√©s √† une autre commande git plus longue. Exemples :

```bash
git config --global alias.st status -sb
git st
```

Sortie :
<pre>
## <font color="#26A269">main</font>...<font color="#C01C28">origin/main</font>
 <font color="#C01C28">M</font> _posts/dev/2024-08-13-git-3.md
 <font color="#C01C28">M</font> _posts/dev/2024-08-13-git-4.md
</pre>

On peut les configurer directement dans le fichier `.gitconfig` qui se trouve dans votre home directory.

```bash
[alias]
    st = status -sb
    ol = log --oneline
    graph = log --oneline --decorate --graph
    graphall = log --oneline --decorate --graph --all
    ca = !git add -A && git commit -m  # Commit all

    discard = reset HEAD --hard # Supprimer toutes les modifications des fichiers suivis depuis le dernier commit
    uncommit = reset --soft HEAD^ # Supprimer le dernier commit sans supprimer les modifications
    unstage = reset HEAD -- # Annuler l'ajout des fichiers dans la staging area
```

#### Les alias bash

Dans `.bashrc`, on peut configurer des alias. Exemple :
```bash
alias ca='git add -A && git commit -m ' # Commit All
ca "Mon message"
```

## Supprimer l'historique
_git reset_

Dans un [pr√©c√©dent article](git-2) de cette s√©rie, je pr√©sentais `git revert` et vous recommandais de l'utiliser de pr√©f√©rence √† `git reset`.  Cependant `git reset` a son int√©r√™t.

`git reset` est une commande qui permet d'√©craser l'historique. Or, s'il y a bien une chose que git n'aime pas pour le travail collaboratif, c'est modifier l'historique. Des historiques non synchronis√©s = probl√®mes assur√©s. N'utilisez `git reset` que si vous √™tes seul sur votre projet ou seul sur votre branche.
Dans l'id√©e, il faut toujours aller de l'avant, un rollback est une modification comme une autre qui m√©rite d'√™tre conserv√©e dans l'historique.

| `git reset`                          | `git log --oneline`                   | Commentaire                                                                                                                                                          |
| ------------------------------------ | ------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `--hard d9d039d`<br/>`--hard HEAD~2` | `d9d039d (HEAD -> main) First commit` | Toutes les commits et leurs modifications jusqu'√† d9d039d seront effac√©es de l'historique                                                                            |
| `--soft d9d039d`<br/>`--soft HEAD~2` | `d9d039d (HEAD -> main) First commit` | Tous les commits jusqu'√† d9d039d seront effac√©s,<br/>les modifications sont conserv√©es mais √† recommiter.<br/>Faire un `git status` pour voir les fichiers √† valider |

Maintenant que vous √™tes devenus des boss de git, vous pouvez manipuler cette dangereuse commande qu'est `git reset`  !

## Nettoyer l'historique
_bfg, git filter-repo_

[`bfg` repo cleaner ](https://rtyley.github.io/bfg-repo-cleaner/) fait du m√©nage pour vous dans l'historique d'un repo. Il permet les choses suivantes :
- supprimer des fichiers de taille importante ou des patterns de fichiers dans l'historique d'un repo
- remplacer des cha√Ænes de caract√®res dans l'historique (pour supprimer des mots de passe, tokens malencontreusement commit√©s)

Git a d√©velopp√© `git filter-repo` plus r√©cemment qui fait concurrence √† `bfg` . `git filter-repo` a l'air tr√®s puissant mais il est plus difficile √† manier et contrairement √† `bfg`, il ne prot√®ge pas le dernier commit.

Attention cependant ! En modifiant l'historique, un repo distant ne sera plus synchronis√©. Il faudra tr√®s certainement se recaler sur la version nettoy√©e du repo et pousser l'int√©gralit√© de l'historique gr√¢ce √† `git push --force`.

## Stocker des fichiers de taille importante
_git lfs_

git n'a pas √©t√© con√ßu pour stocker des fichiers de volume important ou des binaires (m√™me si il peut le faire). Imaginons que vous ayez des fichiers de test, des images, voire des vid√©os que vous souhaitez stocker dans votre repo. Alors peut-√™tre que Git LFS peut vous aider ! Git Large File Storage est un plugin permet de g√©rer ces fichiers diff√©remment :
- sur un repo local, les fichiers volumineux ne sont que des pointeurs jusqu'√† ce que vous ex√©cutiez `git lfs fetch` pour r√©cup√©rer ces fichiers sur le repo distant.
- sur un repo distant, les fichiers point√©s par Git LFS sont stock√©s dans un espace disque sp√©cifique.

J'avais commenc√© √† l'utiliser de mani√®re plus g√©n√©ralis√©e cependant je l'utilise de moins en moins :
- il faut installer `git lfs` sur sa machine et l'initialiser dans son repo,  
- il faut que le repo distant utilise un serveur ou un espace sp√©cifique pour stocker les fichiers volumineux. Sinon ils sont simplement stock√©s sur les disques du repo ! Et donc git lfs est inutile. Donc l'utilisation de Git LFS d√©pend de la d√©cision de l'organisation qui h√©berge votre repo distant.
- pas toujours facile d'avoir tout le monde sur un projet qui utilise Git LFS.

Donc mon point de vue est de ne pas utiliser `git lfs` √† moins que ce soit la seule solution et dans ce cas il faut √™tre organis√© entre tous les contributeurs.rices d'un projet.

 git lfs doit √™tre install√© depuis [ici](https://git-lfs.com/).

## Commandes en vrac

#### `git worktree` 
Si j'avais su que git worktree existait plus t√¥t, j'aurais pu construire la tour Eiffel 3 fois au lieu de perdre mon temps dans des merges conflicts r√©sultant d'un switch entre branches. Git worktree permet de rattacher une branche √† un arbre de travail sp√©cifiquement, c'est √† dire un dossier par branche. Pour plus d'infos : [Git worktree : se d√©nouer les branches](https://leolelonquer.github.io/blog/dev/git-worktree)

#### `git stash` 

Commande permettant de mettre de c√¥t√© des modifs, de faire des op√©rations de branches, puis de r√©appliquer les modifs.

#### `git bisect`

Permet de trouver l'origine d'un bug dans l'historique. Jamais utilis√© (car je d√©veloppe sans bug), le principe est le suivant : vous √™tes au commit A et vous rencontrez un bug, mais vous savez que par le pass√© celui-ci n'existait pas notamment au commit Z. `git bisect` va vous aider √† faire une recherche binaire pour retrouver l'origine du bug introduit.

C'est mieux expliqu√© sur cette question Stack Overflow [How do I use git bisect?](https://stackoverflow.com/questions/4713088/how-do-i-use-git-bisect).

#### Documentation

- `man git-<cmd>` : pour obtenir le r√©f√©rentiel complet des options d'une commande git. `git <cmd> --help` ouvre aussi les manpages 
- `tldr git-<cmd>` : pour obtenir les options et les utilisations les plus fr√©quentes d'une commande git. `tdlr` reste √† installer mais il y a un [site internet](https://tldr.inbrowser.app/)


# Outils graphiques
## IDEs

C'est vrai que dans ce tuto, on a utilis√© uniquement des lignes de commandes. C'est important, parce que si vous voulez d√©panner un repo, mieux vaut bien conna√Ætre les commandes git. Cependant √† l'usage quotidien, on utilise beaucoup les IDE qui int√®grent souvent git. Je pense √† VSCode (ou [VSCodium](https://vscodium.com/)) ou les logiciels de la suite JetBrains (PyCharm, Intellij ...).

**JetBrains**  
J'adore les interfaces JetBrains pour la gestion git. Ce sont les plus clairs et les plus coh√©rentes et une suite d'interface graphique git est int√©gr√© par d√©faut. Jetbrains est en train de sortir [Fleet](https://www.jetbrains.com/fleet/) qui se veut un concurrent de VSCode. J'esp√®re que le projet va rester ouvert ! 

**VSCode**  
Il faut installer des plugins : 
- `Git History` qui permet d'avoir une vue du git log, de voir l'historique d'un fichier. C'est pratique mais assez limit√© comme utilisation.
- `Git Lens` est l'extension la plus utilis√©e, elle est indispensable mais elle est sacr√©ment complexe √† utiliser. De nombreuses fonctionnalit√©s sont bloqu√©es par un acc√®s payant (le graphe complet par exemple !)

## Parcourir l'historique

J'aimerai franchement bien un outil simple qui m'aide √† me balader facilement dans l'historique de mani√®re visuelle sans que j'ai peur de casser quoi que ce soit. Les IDEs et leurs plugins ne sont pas toujours les plus pr√©dispos√©s √† la t√¢che. J'ai test√© plusieurs outils alternatifs et pour l'instant, celui qui ressort c'est [Sublime Merge](https://www.sublimemerge.com/). On esp√®re qu'il reste gratuit !

Avec Sublime Merge, je peux :
- explorer l'historique 
	- sur l'ensemble du repo
	- sur un fichier
	- sur un dossier
	- sur un fichier qui a chang√© de nom
- faire une recherche sur l'historique avec des crit√®res de recherche sp√©cifiques.
- faire des t√¢ches de maintenance git classiques

Pas la possibilit√© de faire des diffs entre fichiers arbitraires cependant üò¢.

Il y a plein d'autres Git GUI dispos, voici [la liste la plus exhaustive](https://git-scm.com/downloads/guis). 

## Diffs

Faire des diffs dans git c'est clairement pas user friendly. 

#### Avec les IDEs

Pour faire des diffs d'un fichier ou d'un dossier avec un autre commit ou une autre branche :

| Outil                    | Actions                                            |
| ------------------------ | -------------------------------------------------- |
| VSCode + plugin Git Lens | Clic droit sur le dossier/fichier > "Open Changes" |
| JetBrains                | Clic droit sur le dossier/fichier > Compare ...    |

#### A la mano

D√®s qu'on veut faire des choses un peu plus compliqu√©es, les IDEs sont dans les choux. Il faut passer par la commande `git diff` dont voici les principales commandes : [tldr git-diff](https://tldr.inbrowser.app/pages/common/git-diff).  
Je rajouterai les √©l√©ments suivants : 

```bash
# X et Y sont des r√©f√©rences (commits, branches, tags, HEAD~3, HEAD@{3 months|weeks|days|hours|seconds ago} indistinctement)

git diff X                    # Diff√©rences avec X
git diff --name-only X        # Noms des fichiers diff√©rents de X
git diff --summary X          # Cr√©ations, renommages et changements de droits de fichiers avec X
git diff X -- chemin          # Diff√©rences avec X pour un chemin sp√©cifiquement (dossier ou fichier) 
git diff X Y                  # Diff√©rences entre X et Y
git diff X Y -- chemin        # Diff√©rences entre X et Y pour un chemin sp√©cifiquement (dossier ou fichier) 
git diff X:cheminA Y:cheminB  # Diff√©rences entre le cheminA de X et cheminB de Y (dossier ou fichiers) 

# Git diff en dehors d'un repo (parce que la coloration est jolie)
git diff --no-index --word-diff old_file.txt new_file.txt
```

#### Avec une UI

`git diff` affiche les diff√©rences dans le terminal. Mais il est possible de voir ces diffs dans une interface graphique. Pour cela il faut remplacer `git diff` par `git difftool` qui va ouvrir votre √©diteur de diff favori (meld, vscode, kompare etc.).

Pour configurer `git difftool` :
```bash
git config --global diff.tool meld
git config --global merge.tool meld
git config --global --add difftool.prompt false
```

#### Astuce git worktree 

Pour √™tre plus libre dans les fichiers que vous voulez tester entre deux branches ou deux commits, je vous conseille d'utiliser `git worktree`. Vous aurez ainsi deux versions de votre projets dans deux dossiers diff√©rents, il deviendra beaucoup plus facile d'utiliser les IDEs et les UIs pour tester les diff√©rences.


# Messages de commits 

Bien √©crire des messages de commits, c'est essentiel. A la fois pour vous, pour se rappeler des changements qui ont √©t√© appliqu√©s sur le repo et pour les autres contributeurs et contributrices du projet. Seulement on est bien d'accord, il n'y a rien de plus fastidieux qu'√©crire un bon message de commit. Si vous parvenez √† √™tre consistant dans ce travail de journaliste, alors cela permet √©galement de compiler beaucoup plus facilement un Changelog.

## Convention commits

Il existe d√©sormais une convention pour √©crire vos commits : [Sp√©cification de la convention](https://www.conventionalcommits.org/fr/v1.0.0/).  
Vous pouvez vous en inspirer pour votre propre r√©daction.  

## AI Takeover

Avec l'√©mergence des LLMs, il devient possible de g√©n√©rer automatiquement les messages de commits. C'est magique ‚ú® Bon apr√®s, c'est pas encore tout √† fait √©vident √† configurer.

| Type de solutions                      | Outils                                                                                                          |
| -------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| Solutions payantes et pr√™tes √† l'usage | - VSCode : GitHub Copilot, Git Lens<br/>- JetBrains : AI Assistant, Github Copilot                              |
| Solutions payantes √† configurer        | CLI : [opencommit](https://github.com/di-sukharev/opencommit) + Model API Key (ex: OpenAPI/Claude/Mistral)      |
| Solutions gratuites √† configurer       | CLI : [opencommit](https://github.com/di-sukharev/opencommit) + Mod√®le local h√©berg√© par ollama (ex: Codestral) |

Voil√† un exemple de message de commit g√©n√©r√© avec llama3 :

```
Generated commit message:
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
docs(thredds-wiz.md): add restricted access information for SXT5_PREVIMER users to IOWAGA-WW3-HINDCAST and IOWAGA-WW3-FORECAST datasets on TDS3
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
```

Il faudrait √©crire un article complet dessus. Je suis encore en train de tester !

# Conclusion

J'esp√®re que vous avez aim√© ce tuto ! Je suis preneur de vos retours.  
Abonnez-vous et activez la cloche pour √™tre les premiers au courant de mes prochaines vid√©os.

## Ressources

- [Lien vers la doc `.gitignore`](https://git-scm.com/docs/gitignore/fr)
- [git worktree](https://leolelonquer.github.io/blog/dev/git-worktree)
- [Learn git branching - Le Jeu](https://learngitbranching.js.org)
- Conf√©rence [So you think you know git ?](https://www.youtube.com/watch?v=aolI_Rz0ZqY) anim√© par Scott Chacon. Beaucoup de bons conseils pour les tr√®s gros repos.

## Pr√©c√©dents articles

1. [Intro](git-0)
2. [Concepts de base](git-1)
3. [Actions fr√©quentes](git-2)
4. [Gitlab - Repo distant](git-3)
5. [Bons √† savoir](git-4)

